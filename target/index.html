

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>offloading to GPU &mdash; LESSON NAME  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/mystnb.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../_static/sphinx_lesson.css" type="text/css" />
  <link rel="stylesheet" href="../_static/sphinx_rtd_theme_ext_color_contrast.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/togglebutton.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="data environment" href="../data/" />
    <link rel="prev" title="OpenMP Offloading" href="../" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../" class="icon icon-home"> LESSON NAME
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">The lesson</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">offloading to GPU</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">host-device model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">device execution model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#target-construct">Target construct</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-parallelism-on-the-target-device">Creating Parallelism on the Target Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="#composite-directive">composite directive</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../data/">data environment</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/">Instructor’s guide</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">LESSON NAME</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../" class="icon icon-home"></a> &raquo;</li>
        
      <li>offloading to GPU</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/coderefinery/content/blob/master/content/target.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="offloading-to-gpu">
<h1>offloading to GPU<a class="headerlink" href="#offloading-to-gpu" title="Permalink to this headline">¶</a></h1>
<div class="admonition-objectives objectives admonition">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Learn how to create .</p></li>
<li><p>Learn how to access</p></li>
</ul>
</div>
<div class="admonition-prerequisites prereq admonition">
<p class="admonition-title">Prerequisites</p>
<ol class="arabic simple">
<li><p>You need</p></li>
<li><p>Basic understanding of Git.</p></li>
<li><p>You need a</p></li>
</ol>
</div>
<div class="section" id="id1">
<h2>host-device model<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Since version 4.0 , OpenMP supports heterogeneous systems. OpenMP uses target  construct to offload execution from the host to the target device(s), and hence the directive name. In addition, the associated data needs to be transferred to the device(s) as well.  By default all variables within the lexical scope of the construct are copied to and from the device and this will be discussed more in the next chapter. Once transferred, the target device owns the data and  accesses by the host during the execution of the target region is forbidden.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ol class="arabic simple">
<li><p>device is host</p></li>
<li><p>data already exists on the device from a previous execution</p></li>
</ol>
</div>
<dl class="simple">
<dt>A host/device model is generally used by OpenMP for offloading:</dt><dd><ul class="simple">
<li><p>Normally there is only one single host: e.g. CPU</p></li>
<li><p>but one or multiple target devices of the same kind: e.g. CPU, GPU, FPGA, …</p></li>
<li><p>unless with unified shared memory, the host and device have separate memory address spac</p></li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Device: An implementation-defined logical execution unit.</p>
</div>
<p>The host is where the  thread begins execution</p>
</div>
<div class="section" id="id2">
<h2>device execution model<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>The execution on the device is host-centric and
1.the host creates the data environments on the device(s)
2.the host maps data to the device data environment, which is data movement to the device
3.the host offloads OpenMP target regions to the target device to be  executed
4.the host transfers data from the device to the host
5.The host destroys the data environment on the device.</p>
<dl>
<dt>code::</dt><dd><div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">binary_blob</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;Hello</span><span class="se">\x00</span><span class="s2">Hello</span><span class="se">\x00</span><span class="s2">&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;attribute_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">void</span><span class="p">(</span><span class="n">binary_blob</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">out</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;attribute_name&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">binary_blob</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="target-construct">
<h2>Target construct<a class="headerlink" href="#target-construct" title="Permalink to this headline">¶</a></h2>
<p>The target construct consists of a target directive and an execution region. It is used to transfer both the control flow  from the host to the device and the data between the host and device.</p>
<dl class="simple">
<dt>Syntax</dt><dd><ul class="simple">
<li><p>C/C++</p></li>
</ul>
</dd>
</dl>
<p>#pragma omp target [clauses]
structured-block</p>
<blockquote>
<div><ul class="simple">
<li><p>Fortran</p></li>
</ul>
</div></blockquote>
<p>!$omp target [clauses]
structured-block
!$omp end target</p>
<blockquote>
<div><ul class="simple">
<li><p>Clauses</p></li>
</ul>
<blockquote>
<div><p>– device(scalar-integer-expression)
– map([{alloc | to | from | tofrom}:] list)
– if(scalar-expr)</p>
</div></blockquote>
</div></blockquote>
<p>Target construct Code Example
<a class="reference external" href="https://github.com/OpenMP/Examples/blob/v4.5.0/sources/Example_target.1.c">https://github.com/OpenMP/Examples/blob/v4.5.0/sources/Example_target.1.c</a>
<a class="reference external" href="https://github.com/OpenMP/Examples/blob/v4.5.0/sources/Example_target.1.f90">https://github.com/OpenMP/Examples/blob/v4.5.0/sources/Example_target.1.f90</a></p>
<dl class="simple">
<dt>To execute code on a target device</dt><dd><p><code class="docutils literal notranslate"><span class="pre">target</span></code>
<code class="docutils literal notranslate"><span class="pre">declear</span> <span class="pre">target</span></code></p>
</dd>
</dl>
<p>Syntax
The <code class="docutils literal notranslate"><span class="pre">declear</span> <span class="pre">target</span></code> directive specifies that variables, functions (C, C++ and Fortran), and subroutines (Fortran) are mapped to a device. The syntax  is as follows:</p>
<blockquote>
<div><ul class="simple">
<li><p>C/C++: <cite>#pragma target [clauses]</cite></p></li>
<li><p>Fortran: <cite>!$OMP target [clauses]</cite></p></li>
</ul>
</div></blockquote>
<p>Commonly used clauses
#pragma omp target [clause[[,]clause]…]
structured-block
if(scalar-expression)
– If the scalar-expression evaluates to false then the target region is executed by the
host device in the host data environment.
device(integer-expression)
– The value of the integer-expression selects the device when a device other than
the default device is desired.
private(list) firstprivate(list)
– creates variables with the same name as those in the list on the device. In the
case of firstprivate, the value of the variable on the host is copied into the private
variable created on the device.
map(map-type: list)
– map-type may be to, from, tofrom, or alloc. The clause defines how the variables
in list are moved between the host and the device. (Lots more on this later)…
nowait
– The target task is deferred which means the host can run code in parallel to the
target region on the device.</p>
</div>
<div class="section" id="creating-parallelism-on-the-target-device">
<h2>Creating Parallelism on the Target Device<a class="headerlink" href="#creating-parallelism-on-the-target-device" title="Permalink to this headline">¶</a></h2>
<dl class="simple">
<dt>OpenMP separates offload and parallelism</dt><dd><ul class="simple">
<li><p>The target construct transfers the control flow to the device in a sequential and synchronous manner</p></li>
<li><p>Programmers need to explicitly create parallel regions on the target device</p></li>
<li><p>In practice, there is only a useful subset of OpenMP features for a target device such as a GPU, e.g., no I/O, limited use of base language features.</p></li>
</ul>
</dd>
</dl>
<p>teams distribute Construct Bristol
The teams construct
–
Similar to the parallel construct
It starts a league of teams
Each team in the league starts with one initial thread – i.e. a team of one thread
Threads in different teams cannot synchronize with each other
The construct must be “perfectly” nested in a target construct
• The distribute construct</p>
<p>Similar to the for construct
Loop iterations are workshared across the initial threads in a league
No implicit barrier at the end of the construct
dist_schedule(kind[, chunk_size])
– If specified, scheduling kind must be static
– Chunks are distributed in round-robin fashion in chunks of size chunk_size
– If no chunk size specified, chunks are of (almost) equal size; each team receives at least one chunk</p>
<p>2020ecp
The target construct offloads the enclosed code to the accelerator: single thread on a device (GPU)
The teams construct creates a league of teams: one thread each, concurrent (not parallel) execution (on SMs)
The parallel construct creates a new team of threads: parallel execution (by hardware threads)
The simd construct indicates SIMD execution is allowed</p>
<p>gpu-derectives
Structured
Has explicit start and end points
Within a single function
Memory exist within the data region
Unstructured
Can have multiple start and end points
Can branch across multiple functions
Memory exists until explicitly deallocated</p>
<p>The creation of <code class="docutils literal notranslate"><span class="pre">MPI_Win</span></code> objects is a collective operation: each process in
the communicator will reserve the specified memory for remote memory accesses.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>The memory window is usually a single array: the size of the window object
then coincides with the size of the array.  If the base type of the array
is a simple type, then the displacement unit is the size of that type,
<em>e.g.</em> <code class="docutils literal notranslate"><span class="pre">double</span></code> and <code class="docutils literal notranslate"><span class="pre">sizeof(double)</span></code>.  You should use a displacement
unit of 1 otherwise.</p></li>
</ul>
</div>
<div class="admonition-window-creation challenge admonition">
<p class="admonition-title">Window creation</p>
<p>Let’s look again at the initial example in the type-along. There we published
an already allocated buffer as memory window. Use the examples above to
figure out how to switch to using <a href="#id3"><span class="problematic" id="id4">|term-MPI_Win_allocate|</span></a></p>
</div>
</div>
<div class="section" id="composite-directive">
<h2>composite directive<a class="headerlink" href="#composite-directive" title="Permalink to this headline">¶</a></h2>
<p>Each compiler supports different levels of parallelism
– LLVM/clang 10, AMD, CCE9, IBM, PGI: teams, parallel
– (Planned) LLVM/Clang 11, Intel: teams, parallel, simd
– CCE8: teams, parallel or teams, simd
•
Caveats:
– Real applications will have algorithms that are structured such that they can’t
immediately use the combined construct.
– It may also make collapse hard to do
– Performance can be achieved without combined directives, but likely won’t be portable</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../data/" class="btn btn-neutral float-right" title="data environment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../" class="btn btn-neutral float-left" title="OpenMP Offloading" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, The contributors.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>